<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>OpenMoCo AVR Libraries: Creating MoCoBus Master Devices</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">OpenMoCo AVR Libraries
   </div>
   <div id="projectbrief">Motion Control and MoCoBus Libraries for the AVR Platform</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.1.1 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('ommaster.html','');});
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">Creating MoCoBus Master Devices </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>A master device sends commands to, and reads responses from, one or more node devices. Generally speaking, a single master may control many types of devices operating on the same bus. In this documentation, we'll cover how to create high-level interfaces that let you easily add several devices of any type to your sketch or program.</p>
<p>When you <a class="el" href="omnode.html">create a MoCoBus node device</a>, you will also want to create a master device which can control it. It is possible to simply create an instance of the <a class="el" href="class_o_m_mo_co_bus.html" title="Core MoCoBus Library.">OMMoCoBus</a> class and use its methods directly, however the <a class="el" href="class_o_m_mo_co_master.html" title="MoCoBus Master Library.">OMMoCoMaster</a> class provides an easier way to define higher-level interfaces to your device without worrying about managing the protocol its self.</p>
<p>It is generally expected that if you provide a new device type, you would also provide a corresponding interface class for that device.</p>
<h1><a class="anchor" id="masteraddr"></a>
Addresses</h1>
<p>All responses to master devices have a target address of 0, and therefore only a single master may be active at a time on one bus. However, it is possible to have a device which operates both as a master (sends commands and listens to responses) and as a node (has an address &gt;= 2, and accepts and responds to commands). This can allow, for example, a single device to operate as a node if it receives a certain command within a certain time, or as a master if it does not.</p>
<h1><a class="anchor" id="masterrefnode"></a>
A Reference Device Type</h1>
<p>In our examples below, we'll be talking to a device. If you haven't already, you should start with the <a class="el" href="omnode.html">Creating MoCoBus Node Devices</a> page.</p>
<p>For many examples that follow in this class, we will use the following node device sketch:</p>
<p>node_sketch.pde: </p>
<div class="fragment"><div class="line"><span class="preprocessor"> #include &quot;OMMoCoNode.h&quot;</span></div>
<div class="line"></div>
<div class="line"> <span class="comment">// RS-485 driver enable pin</span></div>
<div class="line"><span class="preprocessor"> #define DE_PIN 5</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"> <span class="comment">// two commands we can accept...</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor"> #define LED_ON 2</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor"> #define LED_OFF 3</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"> <span class="comment">// device address</span></div>
<div class="line"> byte devAddr = 5;</div>
<div class="line"></div>
<div class="line"> <span class="comment">// device identifiers</span></div>
<div class="line"> <span class="keywordtype">char</span> devId[]  = <span class="stringliteral">&quot;MyDevice&quot;</span>;</div>
<div class="line"> <span class="keywordtype">int</span> devVer    = 1;</div>
<div class="line"></div>
<div class="line"> <span class="comment">// initialize node</span></div>
<div class="line"> <a class="code" href="class_o_m_mo_co_node.html" title="MoCoBus Node Library.">OMMoCoNode</a> Node = <a class="code" href="class_o_m_mo_co_node.html" title="MoCoBus Node Library.">OMMoCoNode</a>(Serial, DE_PIN, devAddr, devVer, devId);</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"> <span class="keywordtype">void</span> setup() {</div>
<div class="line">        Serial.begin(OM_SER_BPS);</div>
<div class="line">        Node.<a class="code" href="class_o_m_mo_co_node.html#aa6cb6e4afb626636d080b6d1799bcd50">setHandler</a>(myHandler);</div>
<div class="line"> }</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"> <span class="keywordtype">void</span> loop() {</div>
<div class="line"></div>
<div class="line">        <span class="comment">// check for a new command and process</span></div>
<div class="line">        <span class="comment">// as needed</span></div>
<div class="line"></div>
<div class="line">         Node.<a class="code" href="class_o_m_mo_co_node.html#a1c69fdbee058f70035fc29a22b53f5a8">check</a>();</div>
<div class="line"> }</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"> <span class="keywordtype">void</span> myHandler(byte command, byte* comData) {</div>
<div class="line"></div>
<div class="line">         <span class="keywordflow">switch</span>(command) {</div>
<div class="line">                <span class="keywordflow">case</span> LED_ON:</div>
<div class="line">                 digitalWrite(13, HIGH);</div>
<div class="line">                 Node.<a class="code" href="class_o_m_mo_co_node.html#ae83ba323f19fde07537d82792cb21a4d">response</a>(<span class="keyword">true</span>);</div>
<div class="line">                 <span class="keywordflow">break</span>;</div>
<div class="line"></div>
<div class="line">                <span class="keywordflow">case</span> LED_OFF:</div>
<div class="line">                 digitalWrite(13, LOW);</div>
<div class="line">                 Node.<a class="code" href="class_o_m_mo_co_node.html#ae83ba323f19fde07537d82792cb21a4d">response</a>(<span class="keyword">true</span>);</div>
<div class="line">                 <span class="keywordflow">break</span>;</div>
<div class="line"></div>
<div class="line">               <span class="keywordflow">default</span>:</div>
<div class="line">                <span class="comment">// unknown command</span></div>
<div class="line">                Node.<a class="code" href="class_o_m_mo_co_node.html#ae83ba323f19fde07537d82792cb21a4d">response</a>(<span class="keyword">false</span>);</div>
<div class="line">          }</div>
<div class="line"> }</div>
</div><!-- fragment --><p>Our device takes two commands, that turn on or off an LED.</p>
<h1><a class="anchor" id="masthow"></a>
How to Interface with A Simple Device</h1>
<p>If you are interacting only with a single device of one type, with a limited command set, then you can create an instance of the <a class="el" href="class_o_m_mo_co_master.html" title="MoCoBus Master Library.">OMMoCoMaster</a> class directly in your sketch and simply use the command() method to speak to the device. This way is quite simple, as the following shows:</p>
<p>simple_master.pde: </p>
<div class="fragment"><div class="line"><span class="preprocessor"> #include &quot;OmMoCoMaster.h&quot;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor"> #define DE_PIN  5</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor"> #define LED_ON  2</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor"> #define LED_OFF 3</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"> byte nodeAddr  = 5;</div>
<div class="line"> <span class="keywordtype">bool</span> on        = <span class="keyword">false</span>;</div>
<div class="line"></div>
<div class="line"> <a class="code" href="class_o_m_mo_co_master.html" title="MoCoBus Master Library.">OMMoCoMaster</a> myBus = <a class="code" href="class_o_m_mo_co_master.html" title="MoCoBus Master Library.">OMMoCoMaster</a>(Serial, DE_PIN);</div>
<div class="line"></div>
<div class="line"> <span class="keywordtype">void</span> setup() {</div>
<div class="line">         Serial.begin(OM_SER_BPS);</div>
<div class="line"> }</div>
<div class="line"></div>
<div class="line"> <span class="keywordtype">void</span> loop() {</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span>( on == <span class="keyword">false</span> ) {</div>
<div class="line">                myBus.<a class="code" href="class_o_m_mo_co_master.html#a1594cfb596378e93d395227d2f72c97e">command</a>(nodeAddr, LED_ON);</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">else</span> {</div>
<div class="line">                 myBus.<a class="code" href="class_o_m_mo_co_master.html#a1594cfb596378e93d395227d2f72c97e">command</a>(nodeAddr, LED_OFF);</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        on = !on;</div>
<div class="line">        sleep(1000);</div>
<div class="line"> }</div>
</div><!-- fragment --><p>However, this is not the preferred method for creating more complex sketches, or sharing your code with others. A better way to handle communicating with your device is to create a simple interface class, which inherits from the <a class="el" href="class_o_m_mo_co_master.html" title="MoCoBus Master Library.">OMMoCoMaster</a> class. In this way, you can share your library with others and re-use code without having to tear apart a sketch to get the right commands, and not to mention - it allows you to use nice, well-named methods for each of your commands. The following section shows how to create an interface class easily, that can then be used as a library in a sketch.</p>
<h1><a class="anchor" id="masterint"></a>
Create an Interface Class</h1>
<p>The <a class="el" href="class_o_m_mo_co_master.html" title="MoCoBus Master Library.">OMMoCoMaster</a> class is intended to be sub-classed by your specific interface. By doing this, your new class will inherit all of the required methods for speaking to devices and you will only need to add methods specific to the commands you want to issue.</p>
<p>Here is an example of a very simple interface class, showing both the header and source code:</p>
<p>device_master.h: </p>
<div class="fragment"><div class="line"><span class="preprocessor"> #include &quot;OMMoCoMaster.h&quot;</span></div>
<div class="line"></div>
<div class="line"> <span class="keyword">class </span>MyDevMaster : <span class="keyword">public</span> <a class="code" href="class_o_m_mo_co_master.html" title="MoCoBus Master Library.">OMMoCoMaster</a> {</div>
<div class="line"></div>
<div class="line"> <span class="keyword">public</span>:</div>
<div class="line"></div>
<div class="line">        MyDevMaster(HardwareSerial&amp; c_serObj, uint8_t c_dePin) : <a class="code" href="class_o_m_mo_co_master.html" title="MoCoBus Master Library.">OMMoCoMaster</a>(c_serObj, uint8_t c_dePin);</div>
<div class="line"></div>
<div class="line">        <span class="keywordtype">int</span> ledOn(uint8_t addr);</div>
<div class="line">        <span class="keywordtype">int</span> ledOff(uint8_t addr);</div>
<div class="line"> };</div>
</div><!-- fragment --><p>Note the constructor syntax &ndash; we're passing on our constructor's arguments to the master class's constructor. We're becoming a more specific version of the master class.</p>
<p>device_master.cpp: </p>
<div class="fragment"><div class="line"><span class="preprocessor"> #include &quot;device_master.h&quot;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor"> #define LED_ON 2</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor"> #define LED_OFF 3</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"> MyDevMaster::MyDevMaster(HardwareSerial&amp; c_serObj, uint8_t c_dePin) : <a class="code" href="class_o_m_mo_co_master.html" title="MoCoBus Master Library.">OMMoCoMaster</a>(c_serObj, c_dePin) {</div>
<div class="line"></div>
<div class="line"> }</div>
<div class="line"></div>
<div class="line"> <span class="keywordtype">int</span> MyDevMaster::ledOn(uint8_t addr) {</div>
<div class="line">        <span class="keywordflow">return</span> command(addr, LED_ON);</div>
<div class="line"> }</div>
<div class="line"></div>
<div class="line"> <span class="keywordtype">int</span> MyDevMaster::ledOff(uint8_t addr) {</div>
<div class="line">         <span class="keywordflow">return</span> command(addr, LED_OFF);</div>
<div class="line"> }</div>
</div><!-- fragment --><p>All of the required construction here is handled by the <a class="el" href="class_o_m_mo_co_master.html" title="MoCoBus Master Library.">OMMoCoMaster</a> class for us, so we just have an empty constructor as a place-holder should we want to do something else.</p>
<p>Our two interface methods, ledOn and ledOff, simply call the inherited command() method with a specific command code the node expects to read.</p>
<p><em>N.B.: the methods for transmitting data on the bus for masters and nodes are command() and response(), respectively. These method names indicate the flow of data, and otherwise create the correct protocol for a particular device.</em></p>
<p>Now, we can use this interface in a sketch to use our device:</p>
<p>master_sketch.pde: </p>
<div class="fragment"><div class="line"><span class="preprocessor"> #include &quot;device_master.h&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor"> #define DE_PIN 5</span></div>
<div class="line"><span class="preprocessor"></span> </div>
<div class="line"> byte nodeAddr  = 5;</div>
<div class="line"> <span class="keywordtype">bool</span> on        = <span class="keyword">false</span>;</div>
<div class="line"> </div>
<div class="line"> MyDevMaster mvDev = MyDevMaster(Serial, DE_PIN);</div>
<div class="line"> </div>
<div class="line"> <span class="keywordtype">void</span> setup() {</div>
<div class="line">        Serial.begin(OM_SER_BPS);</div>
<div class="line"> }</div>
<div class="line"> </div>
<div class="line"> <span class="keywordtype">void</span> loop() {</div>
<div class="line"> </div>
<div class="line">         <span class="keywordflow">if</span>( on == <span class="keyword">false</span> ) {</div>
<div class="line">                 myDev.ledOn(nodeAddr);</div>
<div class="line">         }</div>
<div class="line">         <span class="keywordflow">else</span> {</div>
<div class="line">                myDev.ledOff(nodeAddr);</div>
<div class="line">         }</div>
<div class="line"> </div>
<div class="line">         on = !on;</div>
<div class="line">         sleep(1000);</div>
<div class="line"> }</div>
</div><!-- fragment --><p>The above example alternates between two different high-level commands to our node every second.</p>
<h1><a class="anchor" id="masterresp"></a>
Checking the Response Code from the Node</h1>
<p>Of course, masters expect a response from a node, signaling whether the command was understood and handled. The response code is passed as part of every response packet from the node.</p>
<p>The command() method provides the response code as an integer, indicating the status of the command, as reported by the node. This code can indicate whether there was a timeout waiting for a response, the command was successful, or the command failed.</p>
<p>A response code of -1 indicates a timeout waiting for the response, 1 for successful command, and 0 for failed command.</p>
<p>As an example, we'll modify our master sketch to use this information:</p>
<div class="fragment"><div class="line"> <span class="keywordtype">void</span> loop() {</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span>( on == <span class="keyword">false</span> ) {</div>
<div class="line">                <span class="comment">// check for error</span></div>
<div class="line">                <span class="keywordflow">if</span> ( ! myDev.ledOn(nodeAddr) )</div>
<div class="line">                        digitalWrite(13, HIGH);</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">else</span> {</div>
<div class="line">                <span class="keywordflow">if</span> ( ! myDev.ledOff(nodeAddr) )</div>
<div class="line">                        digitalWrite(13, HIGH);</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        on = !on;</div>
<div class="line">        sleep(1000);</div>
<div class="line"> }</div>
</div><!-- fragment --><p>In our changed loop, we now check to see if the result of our method call is false (0 or -1 in this case). If so, we signal an error by turning on an LED on the master.</p>
<h1><a class="anchor" id="masterdata"></a>
Receiving Data from the Node</h1>
<p>Of course, nodes can transmit us data along with a response code. The node will indicate what type of data it is sending in addition the the actual data.</p>
<p>There are three methods provided for handling responses: responseType(), responseLen(), and responseData(). These indicate the type of data, length of data in bytes, and the actual data respectively.</p>
<p>There are seven types of response data currently supported, and each type is represented using one of the following literals:</p>
<p>R_BYTE, R_UINT, R_INT, R_LONG, R_ULONG, R_FLOAT, R_STR</p>
<p>responseType() will return one of these values, or -1 if no response data was sent. For strings, we may need to know their length, so this we can retrieve using the responseLen() method.</p>
<p>The responseData() method returns a pointer to a byte array containing the actual data sent by the node. If you're sending only a single value of one data type, it is simply converted using one of the built-in conversion methods such as ntoi(), ntof(), etc.</p>
<p>The following shows an example of handling some data responses, in a master interface:</p>
<div class="fragment"><div class="line"> <span class="keywordtype">int</span> MyDevMaster::fooCommand(uint8_t addr) {</div>
<div class="line"></div>
<div class="line">         <span class="keywordtype">int</span> code = command(addr, <span class="charliteral">&#39;f&#39;</span>);</div>
<div class="line"></div>
<div class="line">         <span class="comment">// return zero on error</span></div>
<div class="line">         <span class="keywordflow">if</span>( ! code )</div>
<div class="line">                <span class="keywordflow">return</span> 0;</div>
<div class="line"></div>
<div class="line">         <span class="keywordtype">int</span> rType    = responseType();</div>
<div class="line">         uint8_t* dat = responseData();</div>
<div class="line"></div>
<div class="line">         <span class="keywordflow">if</span>( rType == R_INT ) {</div>
<div class="line">                <span class="keywordflow">return</span> ntoi(dat);</div>
<div class="line">         }</div>
<div class="line">         <span class="keywordflow">else</span> <span class="keywordflow">if</span>( rType == R_STR ) {</div>
<div class="line">                <span class="keywordflow">if</span>( dat == <span class="stringliteral">&quot;OK&quot;</span> )</div>
<div class="line">                        <span class="keywordflow">return</span> 1;</div>
<div class="line">                <span class="keywordflow">else</span></div>
<div class="line">                        <span class="keywordflow">return</span> 0;</div>
<div class="line">         }</div>
<div class="line"> </div>
<div class="line">         <span class="keywordflow">return</span> 0;</div>
<div class="line"> }</div>
</div><!-- fragment --><p>In the above method, we expect to return an integer if the node returns one to us, using the ntoi() method to convert the raw data back into an integer.</p>
<p>Otherwise, if we received a string back, we check to see if it says OK, returning a positive value if it does and zero otherwise.</p>
<h1><a class="anchor" id="masterbcast"></a>
Sending Broadcast Commands to Nodes</h1>
<p>The MoCoBus protocol allows for broadcast commands to be sent to all nodes. To send a broadcast command, direct your command to the address OM_SER_BCAST_ADDR.</p>
<p>Note that since no node may respond to a broadcast command, your command will always have a response code of 1, even if no devices are present on the bus. It is not possible to know from a broadcast command whether it was successfully received by any node. You should limit yourself to broadcast code defintions specified in <a class="el" href="_o_m_mo_co_defs_8h_source.html">OMMoCoDefs.h</a>.</p>
<p>For example, send a start command to all nodes:</p>
<div class="fragment"><div class="line">        command(OM_SER_BCAST_ADDR, OM_BCAST_START);</div>
</div><!-- fragment --><h1><a class="anchor" id="mastervalid"></a>
Validating a Node</h1>
<p>If it is possible that there is more than one type of node on the bus, it is also possible that you may have the wrong address for the node device type you're expecting.</p>
<p>To validate that you're speaking to the right kind of device, you can use the built-in device indentifier and version commands built into the protocol. Neither your master nor your node need to implement any code to create or handle these commands, and the <a class="el" href="class_o_m_mo_co_master.html" title="MoCoBus Master Library.">OMMoCoMaster</a> class includes the built-in getVersion(), getId() methods to retrieve this information for you.</p>
<p>It is useful to add such a check before sending commands to any device, to prevent unintended actions by sending a command with a different meaning to the target device.</p>
<p>The following example adds a new method to our earlier example to validate a node:</p>
<p>device_master.h: </p>
<div class="fragment"><div class="line"><span class="preprocessor"> #include &quot;OMMoCoMaster.h&quot;</span></div>
<div class="line"></div>
<div class="line"> <span class="keyword">class </span>MyDevMaster : <span class="keyword">public</span> <a class="code" href="class_o_m_mo_co_master.html" title="MoCoBus Master Library.">OMMoCoMaster</a> {</div>
<div class="line"></div>
<div class="line"> <span class="keyword">public</span>:</div>
<div class="line"></div>
<div class="line">        MyDevMaster(HardwareSerial&amp; c_serObj, uint8_t c_dePin) : <a class="code" href="class_o_m_mo_co_master.html" title="MoCoBus Master Library.">OMMoCoMaster</a>(c_serObj, uint8_t c_dePin);</div>
<div class="line"></div>
<div class="line">        <span class="keywordtype">int</span> ledOn(uint8_t addr);</div>
<div class="line">        <span class="keywordtype">int</span> ledOff(uint8_t addr);</div>
<div class="line">        <span class="keywordtype">bool</span> validate(uint8_t addr);</div>
<div class="line"></div>
<div class="line"> <span class="keyword">private</span>:</div>
<div class="line"></div>
<div class="line">         <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> devId[]              = <span class="stringliteral">&quot;MyDevice&quot;</span>;</div>
<div class="line">         <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> devVersion   = 1;</div>
<div class="line"></div>
<div class="line"> };</div>
</div><!-- fragment --><p>device_master.cpp: </p>
<div class="fragment"><div class="line"><span class="preprocessor"> #include &quot;device_master.h&quot;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor"> #define LED_ON 2</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor"> #define LED_OFF 3</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"> MyDevMaster::MyDevMaster(HardwareSerial&amp; c_serObj, uint8_t c_dePin) : <a class="code" href="class_o_m_mo_co_master.html" title="MoCoBus Master Library.">OMMoCoMaster</a>(c_serObj, c_dePin) {</div>
<div class="line"></div>
<div class="line"> }</div>
<div class="line"></div>
<div class="line"> <span class="keywordtype">int</span> MyDevMaster::ledOn(uint8_t addr) {</div>
<div class="line">         <span class="keywordflow">return</span> command(addr, LED_ON);</div>
<div class="line"> }</div>
<div class="line"></div>
<div class="line"> <span class="keywordtype">int</span> MyDevMaster::ledOff(uint8_t addr) {</div>
<div class="line">        <span class="keywordflow">return</span> command(addr, LED_OFF);</div>
<div class="line"> }</div>
<div class="line"></div>
<div class="line"> <span class="keywordtype">bool</span> MyDevMaster::validate(uint8_t addr) {</div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">if</span>( getId(addr) != devId || getVersion(addr) != devVersion )</div>
<div class="line">        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"> }</div>
</div><!-- fragment --><p>Our new validate() method returns false if the Id and Version of the remote device are not the expected values.</p>
<p>master_sketch.pde: </p>
<div class="fragment"><div class="line"><span class="preprocessor"> #include &quot;device_master.h&quot;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor"> #define DE_PIN 5</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"> byte nodeAddr  = 5;</div>
<div class="line"> <span class="keywordtype">bool</span> led       = <span class="keyword">false</span>;</div>
<div class="line"> <span class="keywordtype">bool</span> ok        = <span class="keyword">true</span>;</div>
<div class="line"></div>
<div class="line"> MyDevMaster mvDev = MyDevMaster(Serial, DE_PIN);</div>
<div class="line"></div>
<div class="line"> <span class="keywordtype">void</span> setup() {</div>
<div class="line">        Serial.begin(OM_SER_BPS);</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span>( ! myDev.validate(nodeAddr) )</div>
<div class="line">                ok = <span class="keyword">false</span>;</div>
<div class="line"> }</div>
<div class="line"></div>
<div class="line"> <span class="keywordtype">void</span> loop() {</div>
<div class="line"></div>
<div class="line">         <span class="keywordflow">if</span>( ok ) {</div>
<div class="line">                 <span class="keywordflow">if</span>( led == <span class="keyword">false</span> ) {</div>
<div class="line">                         myDev.ledOn(nodeAddr);</div>
<div class="line">                 }</div>
<div class="line">                 <span class="keywordflow">else</span> {</div>
<div class="line">                         myDev.ledOff(nodeAddr);</div>
<div class="line">                 }</div>
<div class="line">                </div>
<div class="line">                 led = !led;</div>
<div class="line">                 sleep(1000);</div>
<div class="line">         }</div>
<div class="line"> }</div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Sun Jun 17 2012 13:59:32 for OpenMoCo AVR Libraries by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.1.1 </li>
  </ul>
</div>
</body>
</html>
